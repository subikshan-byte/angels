{% extends "base.html" %}
{% block meta %}
<meta name="description" content="Checkout securely with Angels Fashion. Complete your order for beauty, fashion, and bridal jewelry from Anna Nagar’s trusted store.">
  <meta name="keywords" content="checkout Angels Fashion, buy cosmetics online Chennai, fashion checkout Anna Nagar, bridal jewelry checkout, secure payment">
  <meta name="robots" content="index, follow">
  <meta name="author" content="Zap Waves">

    
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="About Angels Fashion | Beauty & Fashion Store in Anna Nagar, Chennai">
  <meta property="og:description" content="Discover Angels Fashion's journey – from a single nail polish to a premier beauty & fashion destination in Anna Nagar, Chennai.">
  <meta property="og:image" content="https://www.angels-glamnglow.in/img/favicon_io/android-chrome-512x512.png">
  <meta property="og:url" content="https://www.angels-glamnglow.in/about.html">
  <meta property="og:type" content="website">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="About Angels Fashion | Beauty & Fashion Store in Anna Nagar, Chennai">
  <meta name="twitter:description" content="Learn about Angels Fashion – trusted since 1982 for cosmetics, fashion, and bridal jewelry in Anna Nagar, Chennai.">
  <meta name="twitter:image" content="https://www.angels-glamnglow.in/img/favicon_io/android-chrome-512x512.png">
{% endblock meta %}
{% block title %}Secure Checkout | Angels Fashion Anna Nagar{% endblock title %}
{% block content %}
<style>
:root {
  --primary: #4a6de5;
  --primary-light: #5e82f2;
  --secondary: #f8f9fa;
  --accent: #ff6b6b;
  --text: #333;
  --border: #e0e0e0;
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
}
body { background-color: white; color: var(--text); font-family: 'Poppins', sans-serif; }
.checkout-container { max-width: 1100px; margin: 40px auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
@media (max-width: 768px) { .checkout-container { grid-template-columns: 1fr; } }

.card { background: white; border-radius: 12px; box-shadow: var(--shadow); padding: 25px; }
.card h2, .card h3 { color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }

.info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
.info-label { color: #555; font-weight: 600; } 
.info-value { color: #333; text-align: right; }

.address-section, .coupon-section { background: #f9f9f9; border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
.address-section label, .coupon-section label { font-weight: 600; color: #444; margin-bottom: 8px; display: block; }
.address-section textarea, .coupon-section input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; }
.address-section textarea:focus, .coupon-section input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(74,109,229,0.1); outline: none; }

.apply-btn, .otp-btn { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
.apply-btn:hover, .otp-btn:hover { background-color: var(--primary-light); }
.default__button { background-color: var(--primary); color: white; padding: 14px 25px; border-radius: 8px; width: 100%; text-align: center; border: none; cursor: pointer; font-weight: 500; display: block; transition: 0.3s; }
.default__button:hover { background-color: var(--primary-light); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(74,109,229,0.2); }

.payment-options { display:flex; gap:10px; margin-top:12px; justify-content:center; }
.payment-options button { padding:10px 14px; border-radius:8px; font-weight:600; cursor:pointer; border: none; }
.payment-cod { background:#2ecc71; color:white; } 
.payment-online { background:#3498db; color:white; }

.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:white; border-radius:12px; padding:25px; width:90%; max-width:400px; box-shadow:var(--shadow); text-align:center; }
.modal-content h4 { margin-bottom:10px; color:var(--primary); }
.otp-input { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; margin-top:10px; }
.success-msg { color:#28a745; font-weight:600; margin-top:8px; }
.error-msg { color:#e74c3c; font-weight:600; margin-top:8px; }
.small-muted { font-size:13px; color:#666; margin-top:8px; }
</style>
<div class="breadcrumb">
            <div class="container">
                <div class="row">
                    <div class="col-xl-12">
                        <div class="breadcrumb__title">
                            <h1>check out</h1>
                            <ul>
                                <li>
                                    <a href="{% url "home" %}">Home</a>
                                </li>
                                <li class="color__blue">
                                   CHECK OUT
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<div class="checkout-container">
  <!-- LEFT SIDE: PROFILE & ADDRESS -->
  <div class="card">
    <h2>Delivery Information</h2>
    <div class="user-info">
      <div class="info-item"><div class="info-label">Name:</div><div class="info-value">{{ request.user.first_name }}</div></div>
      <div class="info-item"><div class="info-label">Email:</div><div class="info-value">{{ request.user.email }}</div></div>
      <div class="info-item"><div class="info-label">Mobile:</div><div class="info-value">+91 {{ profile.mobile }}</div></div>
      <div class="info-item"><div class="info-label">Zipcode:</div><div class="info-value">{{ profile.zip_code }}</div></div>
      <div class="info-item"><div class="info-label">Address:</div><div class="info-value">{{ profile.address }}</div></div>
    </div>
    
    <a href="{% url 'myaccount' %}">
      <button name="edit_profile" class="apply-btn" style="margin-top:8px;">My Account</button>
    </a>
  </div>

  <!-- RIGHT SIDE: ORDER + PAYMENT -->
  <div class="card">
    <h3>Your Order</h3>
    <table style="width:100%; margin-bottom:12px;">
      <tr><th>Product</th><th style="text-align:right;">Price</th></tr>
      {% for item in items %}
      <tr><td>{{ item.product.p_name }}</td><td style="text-align:right;">₹{{ item.product.price }}</td></tr>
      {% endfor %}
      <tr><td><strong>Total</strong></td><td style="text-align:right;"><strong id="display-total">₹{{ total_amount }}</strong></td></tr>
    </table>

    <!-- COUPON -->
    <form method="post" id="coupon-form">
      {% csrf_token %}
      <div class="coupon-section">
        <label for="coupon">Have a Coupon?</label>
        <div style="display:flex; gap:10px;">
          <input type="text" id="coupon" name="coupon" placeholder="Enter coupon code">
          <button type="button" id="apply-coupon" class="apply-btn">Apply</button>
        </div>
        <div id="coupon-msg" class="small-muted"></div>
      </div>
    </form>

    <!-- OTP Step -->
    <button type="button" class="otp-btn" id="send-otp" style="width:100%;">Proceed to OTP Verification</button>

    <!-- Razorpay button (hidden until verified & selected) -->
    <div id="razorpay-container" style="display:none; margin-top:15px;">
      <button id="pay-online-launch" class="default__button">Pay Online (Razorpay)</button>
    </div>
  </div>
</div>

<!-- OTP MODAL -->
<div class="modal-overlay" id="otp-modal">
  <div class="modal-content">
    <h4>Verify Your OTP</h4>
    <p class="small-muted">We’ve sent a 6-digit OTP to your email: <b>{{ request.user.email }}</b></p>
    <input type="text" id="otp-input" class="otp-input" placeholder="Enter 6-digit OTP" maxlength="6" inputmode="numeric">
    <div id="otp-message" class="small-muted"></div>
    <div style="margin-top:12px;">
      <button class="otp-btn" id="verify-otp">Verify OTP</button>
      <button class="apply-btn" id="resend-otp" style="background:#f39c12;">Resend OTP</button>
    </div>
    <div id="payment-choices" style="display:none; margin-top:14px;">
      <p class="small-muted">Choose payment method:</p>
      <div class="payment-options">
        <button class="payment-cod" id="choose-cod">Cash on Delivery</button>
        <button class="payment-online" id="choose-online">Pay Online</button>
      </div>
      <div id="payment-msg" class="small-muted"></div>
    </div>
  </div>
</div>

<script>
// === CSRF ===
function getCookie(name){let v=null;if(document.cookie){document.cookie.split(';').forEach(c=>{c=c.trim();if(c.startsWith(name+'='))v=decodeURIComponent(c.substring(name.length+1));});}return v;}
const csrftoken=getCookie('csrftoken');
paymentrazor
// ELEMENTS
const sendOtpBtn=document.getElementById('send-otp'),otpModal=document.getElementById('otp-modal'),
verifyOtpBtn=document.getElementById('verify-otp'),resendOtpBtn=document.getElementById('resend-otp'),
otpInput=document.getElementById('otp-input'),otpMsg=document.getElementById('otp-message'),
paymentChoices=document.getElementById('payment-choices'),chooseCod=document.getElementById('choose-cod'),
chooseOnline=document.getElementById('choose-online'),couponInput=document.getElementById('coupon'),
applyCouponBtn=document.getElementById('apply-coupon'),couponMsg=document.getElementById('coupon-msg'),
displayTotal=document.getElementById('display-total'),addressField=document.getElementById('addr'),
addressMsg=document.getElementById('address-msg'),saveAddressBtn=document.getElementById('save-address'),
razorpayContainer=document.getElementById('razorpay-container');

let lastVerified=false;

// MODAL HANDLERS
function openOtpModal(){otpModal.style.display='flex';otpInput.value='';otpMsg.textContent='';paymentChoices.style.display='none';}
function closeOtpModal(){otpModal.style.display='none';}
otpModal.addEventListener('click',e=>{if(e.target===otpModal)closeOtpModal();});

// === SEND OTP ===
sendOtpBtn.addEventListener('click',()=>{
fetch("{% url 'send_checkout_otp1' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'}})
.then(r=>r.json()).then(d=>{if(d.status==='sent'){openOtpModal();otpMsg.textContent='OTP sent.';}else alert('Failed to send OTP.');})
.catch(()=>alert('Network error.'));
});

// === RESEND OTP ===
resendOtpBtn.addEventListener('click',()=>{
fetch("{% url 'send_checkout_otp1' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'}})
.then(r=>r.json()).then(d=>{otpMsg.textContent=d.status==='sent'?'OTP resent.':'Failed to resend.';});
});

// === VERIFY OTP ===
verifyOtpBtn.addEventListener('click',()=>{
const otp=otpInput.value.trim();
if(!otp){otpMsg.textContent='Enter OTP';otpMsg.className='error-msg';return;}
fetch("{% url 'verify_order_otp1' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'},body:JSON.stringify({otp})})
.then(r=>r.json()).then(d=>{
if(d.status==='verified'){otpMsg.textContent='Verified!';otpMsg.className='success-msg';paymentChoices.style.display='block';lastVerified=true;}
else{otpMsg.textContent='Invalid OTP';otpMsg.className='error-msg';}
});
});

// === APPLY COUPON ===
applyCouponBtn.addEventListener('click',()=>{
fetch("{% url 'apply_coupon' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'},body:JSON.stringify({coupon:couponInput.value.trim()})})
.then(r=>r.json()).then(d=>{
if(d.status==='ok'){displayTotal.textContent='₹'+d.total;couponMsg.textContent='Coupon applied!';}
else{couponMsg.textContent='Invalid coupon.';}
});
});

// === SAVE ADDRESS ===
saveAddressBtn.addEventListener('click',()=>{
fetch("{% url 'edit' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'},body:JSON.stringify({address:addressField.value.trim()})})
.then(r=>r.json()).then(d=>{addressMsg.textContent=d.status==='ok'?'Saved!':'Failed.';});
});

// === CHOOSE COD ===
chooseCod.addEventListener('click',()=>{
if(!lastVerified){otpMsg.textContent='Verify OTP first.';return;}
fetch("{% url 'place_cod_order1' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'},body:JSON.stringify({address:addressField.value.trim(),coupon:couponInput.value.trim()})})
.then(r=>r.json()).then(d=>{if(d.status==='placed')window.location.href=d.redirect;else document.getElementById('payment-msg').textContent=d.message;});
});

// === CHOOSE ONLINE ===
chooseOnline.addEventListener('click',()=>{
if(!lastVerified){otpMsg.textContent='Verify OTP first.';return;}
fetch("{% url 'create_razorpay_order1' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/json'},body:JSON.stringify({coupon:couponInput.value.trim(),address:addressField.value.trim()})})
.then(r=>r.json()).then(data=>{
if(data.status==='created'){
const opt={key:data.key,amount:data.amount,currency:'INR',order_id:data.order_id,
handler:function(res){window.location.href="{% url 'payment_success1' %}?pid="+res.razorpay_payment_id;},theme:{color:'#4a6de5'}};
new Razorpay(opt).open();
}});
});
</script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

{% endblock %}
